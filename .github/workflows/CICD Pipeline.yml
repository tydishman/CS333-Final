name: CI/CD Pipeline
on:
    push:
        branches: [ $default-branch, main ]
    pull_request:
        branches: [ $default-branch, main ]

jobs:
    test:
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install pytest
            pip install -r requirements.txt
        - name: Test with pytest
          run: |
            python -m pytest
    dockerhub-push:
      # https://docs.docker.com/reference/cli/docker/login/#password-stdin
      needs: test
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4
        - name: Login to Dockerhub via CLI
          env:
            DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
            DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
          run: cat "$DOCKERHUB_PASS" | docker login --username "$DOCKERHUB_USER" --password-stdin
        - name: Build and push image
          run: |
            docker build -t tdishman/cs333_final:v1 .
            docker push tdishman/cs333_final:v1
          
